
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>index</title>
	<link rel="stylesheet" href="./css/bootstrap.css">
    <link rel="stylesheet" href="./css/bootstrap-responsive.css">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<? if("http://".$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI']=="http://gurylyov.ru/samples/razin/index.php" && isset($_GET['vk']) && $_GET['vk']==1) { ?>

<? } else { ?>

<? } ?>
	<style>
	body {
		padding-top: 20px;
	}
	#codes_form {
		padding-top: 20px;
	}
	.container {
		width: 600px;
		margin: 0 auto;
	}
	#content {
		display: none;
	}
	.status {
		float: left;
		vertical-align: middle;
		margin: 7px 7px 7px 0;
	}
<? if("http://".$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI']=="http://gurylyov.ru/samples/razin/index.php" && !isset($_GET['vk'])) { ?>
	#login, #logout {
		height: 21px;
		background: url("./img/login.png") no-repeat;
	}
	#login {
		width: 125px;
	}
	#logout {
		width: 126px;
		background-position: 0 -21px;
	}
<? } ?>
	.load {
		background: url("./img/load.gif") no-repeat;
	}
    </style>
</head>
<body>
<div class="container">
	<span id="top"></span>
	<a href="" id="login"></a>
	<a href="" id="logout"></a>
	<div id="content">
		<div id="getProfileUploadServer"></div>
		<div id="saveProfilePhoto"></div>
		<form action="" id="codes_form">
			<label for="" class="codes_label">
				<i class="icon-black status"></i>
				<input type="text" class="codes" id="code0">
			</label>
			<label for="" class="codes_label">
				<i class="icon-black status"></i>
				<input type="text" class="codes" id="code1">
			</label>
			<label for="" class="codes_label">
				<i class="icon-black status"></i>
				<input type="text" class="codes" id="code2">
			</label>
			<label for="" class="codes_label">
				<i class="icon-black status"></i>
				<input type="text" class="codes" id="code3">
			</label>
			<label for="" class="codes_label">
				<i class="icon-black status"></i>
				<input type="text" class="codes" id="code4">
			</label>
		</form>
	</div>
</div>
<script>
var api=0, count=0;
if(location.href.search(unescape('api')) != -1) {
	console.log('Ифрейм загружен из приложения, а не с сайта');
	include('http://vk.com/js/api/xd_connection.js?2');
	
} else {
	console.log('Ифрейм загружен с сайта, а не из приложения');
	include('http://vk.com/js/api/openapi.js');
	api=1;
}
$(function() {
pic = new Image(); pic.src="./img/load.gif"; // предзагрузка загрузки
	setTimeout(function() {
		if(api==1) { // если с сайта
			$('#login').click(function(event){
				event.preventDefault();
				VK.Auth.login(authInfo, 4);
			});
			$('#logout').click(function(event){
				event.preventDefault();
				VK.Auth.logout(authInfo);
			});
			VK.init({
			  apiId: 1938435
			});
			function authInfo(response) {
			  if (response.session) {
				console.log('user: '+response.session.mid);
				document.getElementById('login').style.display = 'none';
				document.getElementById('logout').style.display = 'block';
				document.getElementById('top').style.display = 'none';
				document.getElementById('top').innerHTML='Введи 5 кодов из-под крышек пива "Степан Разин" и получи доступ к уникальному контенту в группе "Степана" ВКонтакте!';
			  } else {
				console.log('user: not auth');
				document.getElementById('login').style.display = 'block';
				document.getElementById('logout').style.display = 'none';
				document.getElementById('content').style.display = 'none';
				document.getElementById('top').innerHTML='Ещё больше увлекательных конкурсов и ценных призов для друзей "Степана" в группе ВКонтакте.<br><b>Для участия войдите с помощью своего аккаунта ВКонтакте.</b>';
			  }
			}
			VK.Observer.subscribe('auth.login', function(response) {
				var photo = 'return { me: API.users.get({uids: API.getVariable({key: 1280}), fields: "screen_name,photo_big"})[0]};';
				VK.Api.call('execute', {'code': photo}, _getProfile);
			});
			function _getProfile(data) {
				if (data.response) {
					if (data.response.me) {
						var i = data.response.me;
						$.getJSON('http://gurylyov.ru/samples/razin/login.php', {login:i.uid}, function(data){
							console.log('user: '+i.uid);
							console.log('user: ' + i.first_name + ' ' + i.last_name);
							console.log('link: http://vk.com/' + i.screen_name);
							console.log('photo: ' + i.photo_big);
							count=data.codeCount;
							console.log('кодов введено: ' + count);
							if(count==5) {
								document.getElementById('top').innerHTML='<h1>Вы стали другом Степана Разина!</h1><p>Теперь вам доступен уникальный контент <a href="http://vk.com/page-25560758_43897020" target="_blank">в группе бренда ВКонтакте</a>. Выберите символ, который будет добавлен к вашей аватарке, в знак дружбы с легендарным пиво.</p>';
								document.getElementById('content').style.display = 'none';
							} else {
								console.log('осталось: ' + (5-count));
							}
						});
					
						$.getJSON('http://gurylyov.ru/samples/razin/get_codes.php', {login: i.uid}, function(data1){
							for (var i = 0; i < 5; i++) {
								if(data1['code' + i] != undefined) {
									$('#code' + i).val(data1['code' + i]);
									$('#code' + i).attr('disabled', 'disabled');
									$('#code' + i).prev().addClass('icon-ok');
								}
							}
						});
					
					$(".codes").each(function(indx, element){
						$(element).keyup(function(e){
							var v = $(element).val();
							if(v.length == 8){
								$(element).attr('disabled','disabled').addClass('disabled').blur();
								$(element).prev().addClass('load');
								$.getJSON('http://gurylyov.ru/samples/razin/add_code.php', {login: i.uid, codes: v}, function(data1){
									if(data1)
									{
										document.getElementById('content').style.display = 'block';
										$(element).prev().removeClass('load icon-ok').addClass('icon-remove');
										$(element).removeAttr('disabled').removeClass('disabled').blur();
									}
									else
									{
										$(element).prev().removeClass('load icon-remove').addClass('icon-ok');
										count++;
										if(count==5) {
											document.getElementById('t').style.display = 'block';
											document.getElementById('top').innerHTML='<h1>Вы стали другом Степана Разина!</h1><p>Теперь вам доступен уникальный контент <a href="http://vk.com/page-25560758_43897020" target="_blank">в группе бренда ВКонтакте</a>. Выберите символ, который будет добавлен к вашей аватарке, в знак дружбы с легендарным пиво.</p>'; 
										} else {
											document.getElementById('content').style.display = 'block';
											console.log('осталось: ' + (5-count));
										}
									}
								});
							} else if(v.length > 8){
								$(this).prev().addClass('icon-remove');
							}
						});
					});
						
					}
				} else {
					document.getElementById('content').innerHTML = 'error'; 
				}
			}

			VK.Auth.getLoginStatus(authInfo);
			
		} else { // если из приложения
		
			document.getElementById('login').style.display = 'none';
			document.getElementById('logout').style.display = 'none';
			document.getElementById('content').style.display = 'block';
			document.getElementById('top').innerHTML='Введи 5 кодов из-под крышек пива "Степан Разин" и получи доступ к уникальному контенту в группе "Степана" ВКонтакте!';
			
			VK.init(function() {
			
				VK.loadParams(document.location.href);
				var viewer_id = VK.params.viewer_id;
				VK.callMethod('showInstallBox',4);
				VK.api("getProfiles", {uids:viewer_id,fields:"screen_name,photo_big"}, function(data) {
					var i = data.response[0];
					$.getJSON('http://gurylyov.ru/samples/razin/login.php', {login:i.uid}, function(data){
						console.log('user: '+i.uid);
						console.log('user: ' + i.first_name + ' ' + i.last_name);
						console.log('link: http://vk.com/' + i.screen_name);
						console.log('photo: ' + i.photo_big);
						count=data.codeCount;
						console.log('кодов введено: ' + count);
						if(count==5) {
							document.getElementById('top').innerHTML='<h1>Вы стали другом Степана Разина!</h1><p>Теперь вам доступен уникальный контент <a href="http://vk.com/page-25560758_43897020" target="_blank">в группе бренда ВКонтакте</a>. Выберите символ, который будет добавлен к вашей аватарке, в знак дружбы с легендарным пиво.</p>';
							document.getElementById('content').style.display = 'none';
						} else {
							console.log('осталось: ' + (5-count));
						}
					});
					/*VK.api('photos.getProfileUploadServer', function(data) {
						document.getElementById('getProfileUploadServer').innerHTML=data.response.upload_url;
						if(data.response.upload_url) {
								$.post("vkSender.php", {upload_url: data.response.upload_url}, function(data1){
									alert(data1.server)
									VK.api('photos.saveProfilePhoto', {server: data1.server, photo: data1.photo, hash: data1.hash}, function(data2) {
										alert(data2.error.error_code)
										document.getElementById('saveProfilePhoto').innerHTML=data2.response.photo_src;
									});
								});
						}
					});*/ 
					$.getJSON('http://gurylyov.ru/samples/razin/get_codes.php', {login: i.uid}, function(data1){
					
						for (var i = 0; i < 5; i++) { 
							if(data1['code' + i] != undefined) {
								$('#code' + i).val(data1['code' + i]);
								$('#code' + i).attr('disabled', 'disabled');
								$('#code' + i).prev().addClass('icon-ok');
							}
						}
					});
					
					$(".codes").each(function(indx, element){
						$(element).keyup(function(e){
							var v = $(element).val();
							if(v.length == 8){
								$(element).attr('disabled','disabled').addClass('disabled').blur();
								$(element).prev().addClass('load');
								$.getJSON('http://gurylyov.ru/samples/razin/add_code.php', {login: i.uid, codes: v}, function(data1){
									if(data1)
									{
										$(element).prev().removeClass('load icon-ok').addClass('icon-remove');
										$(element).removeAttr('disabled').removeClass('disabled').blur();
									}
									else
									{
										$(element).prev().removeClass('load icon-remove').addClass('icon-ok');
										count++;
										if(count==5) {
											document.getElementById('top').innerHTML='<h1>Вы стали другом Степана Разина!</h1><p>Теперь вам доступен уникальный контент <a href="http://vk.com/page-25560758_43897020" target="_blank">в группе бренда ВКонтакте</a>. Выберите символ, который будет добавлен к вашей аватарке, в знак дружбы с легендарным пиво.</p>';
											document.getElementById('content').style.display = 'none';
										} else {
											console.log('осталось: ' + (5-count));
										}
									}
								});
							} else if(v.length > 8){
								$(this).prev().addClass('icon-remove');
							}
						});
					});
				});
			});
		}
	}, 1000);
});
function include(adr) {
	var el = document.createElement('script');
	el.src = adr;
	el.type = 'text/javascript';
	el.async = true;
	document.getElementsByTagName('head')[0].appendChild(el);
}
</script>
</body>
</html>
