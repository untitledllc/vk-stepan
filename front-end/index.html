
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>index</title>
	<link rel="stylesheet" href="./css/bootstrap.css">
    <link rel="stylesheet" href="./css/bootstrap-responsive.css">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<style>
      body {
        padding-top: 20px;
      }
	  #codes_form {
		padding-top: 20px;
	  }
	.status {
		float: left;
		vertical-align: middle;
		margin: 7px 7px 7px 0;
	}
	#login, #logout {
		height: 21px;
		background: url("./img/login.png") no-repeat;
	}
	#login {
		width: 125px;
	}
	#logout {
		width: 126px;
		background-position: 0 -21px;
	}
	.load {
		background: url("./img/load.gif") no-repeat;
	}
    </style>
</head>
<body>
<div class="container">
	<span id="hm"></span>
	<a href="" id="login"></a>
	<a href="" id="logout"></a>
	<form action="" id="codes_form">
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code0">
		</label>
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code1">
		</label>
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code2">
		</label>
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code3">
		</label>
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code4">
		</label>
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code5">
		</label>
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code6">
		</label>
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code7">
		</label>
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code8">
		</label>
		<label for="" class="codes_label">
			<i class="icon-black status"></i>
			<input type="text" class="codes" id="code9">
		</label>
	</form>
</div>
<script>
var api=0;
if(top.location.host==undefined) {
	console.log('Ифрейм загружен из приложения, а не с сайта');
	include('http://vk.com/js/api/xd_connection.js?2');
	
} else {
	console.log('Ифрейм загружен с сайта, а не из приложения');
	include('http://vk.com/js/api/openapi.js');
	api=1;
}
$(function() {
pic = new Image();
pic.src="./img/load.gif";
	setTimeout(function() {
		if(api==1) { // если с сайта
			$('#login').click(function(event){
				event.preventDefault();
				VK.Auth.login(authInfo, VK.access.FRIENDS);
			});
			$('#logout').click(function(event){
				event.preventDefault();
				VK.Auth.logout(authInfo);
			});
			VK.init({
			  apiId: 1938435
			});
			function authInfo(response) {
			  if (response.session) {
				console.log('user: '+response.session.mid);
				document.getElementById('login').style.display = 'none';
				document.getElementById('logout').style.display = 'block';
			  } else {
				console.log('user: not auth');
				document.getElementById('logout').style.display = 'none';
				document.getElementById('login').style.display = 'block';
			  }
			}
			VK.Observer.subscribe('auth.login', function(response) {
				var photo = 'return { me: API.users.get({uids: API.getVariable({key: 1280}), fields: "screen_name,photo_big"})[0]};';
				VK.Api.call('execute', {'code': photo}, _getProfile);
			});
			function _getProfile(data) {
				if (data.response) {
					if (data.response.me) {
						var i = data.response.me;
						console.log('user: ' + i.first_name + ' ' + i.last_name);
						console.log('link: http://vk.com/' + i.screen_name);
						console.log('photo: ' + i.photo_big);
						
						$.getJSON('http://gurylyov.ru/samples/razin/get_codes.php', {login: i.uid}, function(data1){
					
						for (var i = 0; i < 10; i++) {
								if(data1['code' + i] != undefined) {
										$('#code' + i).val(data1['code' + i]);
										$('#code' + i).attr('disabled', 'disabled');
										$('#code' + i).prev().addClass('icon-ok');
								}
						}
					});
					
					$(".codes").each(function(indx, element){
						$(element).keyup(function(e){
							var v = $(element).val();
							if(v.length == 8){
								$(element).attr('disabled','disabled').addClass('disabled').blur();
								$(element).prev().addClass('load');
								$.getJSON('http://gurylyov.ru/samples/razin/add_code.php', {login: i.uid, codes: v}, function(data1){
									if(data1)
									{
										$(element).prev().removeClass('load').addClass('icon-remove');
										$(element).removeAttr('disabled').removeClass('disabled').blur();
									}
									else
									{
										$(element).prev().removeClass('load').addClass('icon-ok');
									}
								});
							} else if(v.length > 8){
								$(this).prev().addClass('icon-remove');
							}
						});
					});
						
					}
				} else {
					document.getElementById('content').innerHTML = 'error'; 
				}
			}

			VK.Auth.getLoginStatus(authInfo);
			
		} else { // если из приложения
		
			document.getElementById('login').style.display = 'none';
			document.getElementById('logout').style.display = 'none';
			
			VK.init(function() {
			
				VK.loadParams(document.location.href);
				var viewer_id = VK.params.viewer_id;
				
				VK.api("getProfiles", {uids:viewer_id,fields:"screen_name,photo_big"}, function(data) {
					var i = data.response[0];
					$.getJSON('http://gurylyov.ru/samples/razin/login.php', {login:i.uid}, function(data){});
						console.log('user: '+i.uid);
						console.log('user: ' + i.first_name + ' ' + i.last_name);
						console.log('link: http://vk.com/' + i.screen_name);
						console.log('photo: ' + i.photo_big);
					
					$.getJSON('http://gurylyov.ru/samples/razin/get_codes.php', {login: i.uid}, function(data1){
					
						for (var i = 0; i < 10; i++) {
								if(data1['code' + i] != undefined) {
										$('#code' + i).val(data1['code' + i]);
										$('#code' + i).attr('disabled', 'disabled');
										$('#code' + i).prev().addClass('icon-ok');
								}
						}
					});
					
					$(".codes").each(function(indx, element){
						$(element).keyup(function(e){
							var v = $(element).val();
							if(v.length == 8){
								$(element).attr('disabled','disabled').addClass('disabled').blur();
								$(element).prev().addClass('load');
								$.getJSON('http://gurylyov.ru/samples/razin/add_code.php', {login: i.uid, codes: v}, function(data1){
									if(data1)
									{
										$(element).prev().removeClass('load').addClass('icon-remove');
										$(element).removeAttr('disabled').removeClass('disabled').blur();
									}
									else
									{
										$(element).prev().addClass('icon-ok');
									}
								});
							} else if(v.length > 8){
								$(this).prev().addClass('icon-remove');
							}
						});
					});
				});
			});
		}
	}, 1000);
});
function include(adr) {
	var el = document.createElement('script');
	el.src = adr;
	el.type = 'text/javascript';
	el.async = true;
	document.getElementsByTagName('head')[0].appendChild(el);
}
</script>
<!-- <script src="../assets/js/jquery.js"></script>
<script src="../assets/js/bootstrap-transition.js"></script>
<script src="../assets/js/bootstrap-alert.js"></script>
<script src="../assets/js/bootstrap-modal.js"></script>
<script src="../assets/js/bootstrap-dropdown.js"></script>
<script src="../assets/js/bootstrap-scrollspy.js"></script>
<script src="../assets/js/bootstrap-tab.js"></script>
<script src="../assets/js/bootstrap-tooltip.js"></script>
<script src="../assets/js/bootstrap-popover.js"></script>
<script src="../assets/js/bootstrap-button.js"></script>
<script src="../assets/js/bootstrap-collapse.js"></script>
<script src="../assets/js/bootstrap-carousel.js"></script>
<script src="../assets/js/bootstrap-typeahead.js"></script>
 --></body>
</html>
